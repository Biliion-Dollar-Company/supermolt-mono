/**
 * Treasury API Routes
 * 
 * Endpoints for USDC treasury management and reward distribution
 * 
 * Routes:
 * - GET  /treasury/status - Get treasury balance and status
 * - GET  /treasury/allocations/:epochId - Preview allocations
 * - POST /treasury/distribute/:epochId - Execute distribution
 * - GET  /treasury/scanner/:scannerId/allocations - Scanner history
 * 
 * Created: February 5, 2026
 * By: Backend Infrastructure Agent
 */

import { Hono } from 'hono';
import { treasuryManager } from '../services/treasury-manager.service';

const treasury = new Hono();

/**
 * GET /treasury/status
 * 
 * Get current treasury status:
 * - Total USDC balance
 * - Allocated (pending distributions)
 * - Distributed (completed)
 * - Available for new allocations
 */
treasury.get('/status', async (c) => {
  try {
    const status = await treasuryManager.getTreasuryStatus();

    return c.json({
      success: true,
      ...status,
    });
  } catch (error: any) {
    console.error('Error fetching treasury status:', error);
    return c.json({
      success: false,
      error: error.message,
    }, 500);
  }
});

/**
 * GET /treasury/allocations/:epochId
 * 
 * Preview USDC allocations for an epoch (dry run)
 * Does NOT send transactions - just calculates amounts
 * 
 * Response includes:
 * - Each scanner's allocation amount
 * - Rank and performance metrics
 * - Total amount needed
 * - Current treasury balance
 */
treasury.get('/allocations/:epochId', async (c) => {
  try {
    const epochId = c.req.param('epochId');

    const allocations = await treasuryManager.calculateAllocations(epochId);
    const balance = await treasuryManager.getBalance();

    const totalAmount = allocations.reduce((sum, a) => sum + a.usdcAmount, 0);

    return c.json({
      success: true,
      epochId,
      allocations,
      totalAmount: Math.round(totalAmount * 100) / 100,
      availableBalance: Math.round(balance * 100) / 100,
      sufficientFunds: balance >= totalAmount,
    });
  } catch (error: any) {
    console.error('Error calculating allocations:', error);
    return c.json({
      success: false,
      error: error.message,
    }, 500);
  }
});

/**
 * POST /treasury/distribute/:epochId
 * 
 * Execute USDC distribution for an epoch
 * 
 * âš ï¸ WARNING: This sends REAL USDC on Solana mainnet!
 * 
 * Steps:
 * 1. Calculate allocations
 * 2. Verify treasury balance
 * 3. Send USDC to each scanner
 * 4. Record transactions in database
 * 5. Update epoch status to PAID
 * 
 * Response includes:
 * - Transaction signatures for each scanner
 * - Solscan links for verification
 * - Success/failure status per scanner
 * - Summary (total, successful, failed)
 */
treasury.post('/distribute/:epochId', async (c) => {
  try {
    const epochId = c.req.param('epochId');

    console.log(`ðŸš€ Starting distribution for epoch ${epochId}...`);

    const result = await treasuryManager.distributeRewards(epochId);

    if (result.summary.failed > 0) {
      console.warn(`âš ï¸ Distribution completed with ${result.summary.failed} failures`);
      return c.json({
        success: true,
        message: 'Distribution completed with some failures',
        ...result,
      }, 207);
    } else {
      console.log(`âœ… Distribution completed successfully: ${result.summary.successful} scanners`);
      return c.json({
        success: true,
        message: 'All distributions successful',
        ...result,
      });
    }
  } catch (error: any) {
    console.error('âŒ Distribution failed:', error);
    return c.json({
      success: false,
      error: error.message,
    }, 500);
  }
});

/**
 * GET /treasury/scanner/:scannerId/allocations
 * 
 * Get allocation history for a specific scanner
 * 
 * Response includes:
 * - All past allocations (with tx signatures)
 * - Total USDC earned all-time
 * - Epoch details for each allocation
 * - Transaction status (completed/failed/pending)
 */
treasury.get('/scanner/:scannerId/allocations', async (c) => {
  try {
    const scannerId = c.req.param('scannerId');

    const history = await treasuryManager.getScannerAllocations(scannerId);

    return c.json({
      success: true,
      scannerId,
      ...history,
    });
  } catch (error: any) {
    console.error('Error fetching scanner allocations:', error);
    return c.json({
      success: false,
      error: error.message,
    }, 500);
  }
});

/**
 * GET /treasury/balance
 * 
 * Simple endpoint to get just the USDC balance
 * Useful for quick checks and monitoring
 */
treasury.get('/balance', async (c) => {
  try {
    const balance = await treasuryManager.getBalance();

    return c.json({
      success: true,
      balance: Math.round(balance * 100) / 100,
      usdcMint: 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v',
      treasuryWallet: treasuryManager.getTreasuryPublicKey(),
    });
  } catch (error: any) {
    console.error('Error fetching balance:', error);
    return c.json({
      success: false,
      error: error.message,
    }, 500);
  }
});

export { treasury };
